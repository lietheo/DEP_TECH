<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Analyse des Al√©as et Risques Territoriaux</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- Styles de Structure, Contr√¥les, L√©gende et Tableau --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: row; 
            height: 100vh; 
            overflow: hidden; 
            color: #333; 
        }

        #map { 
            flex: 3; 
            min-width: 600px; 
            height: 100%; 
        }
        
        #controls { 
            flex: 1; 
            padding: 20px; 
            background-color: #f8f9fa; 
            min-width: 320px; 
            box-sizing: border-box; 
            overflow-y: auto; 
            height: 100%; 
            display: flex;
            flex-direction: column; 
        }

        h2, h3, h4 { color: #333; }
        
        h2 { 
            margin-top: 0; 
            margin-bottom: 5px; 
            padding-bottom: 5px; 
            border-bottom: 1px solid #eee; 
            font-weight: 600; 
        }
        
        h3 {
            border-bottom: 1px solid #eee; 
            padding-bottom: 10px; 
            margin-top: 20px; 
            margin-bottom: 15px; 
            font-weight: 600;
        }

        #communeTableContainer h4 {
            font-size: 1.1em;
            margin-top: 10px; 
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        #risk-selector-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            gap: 10px;
        }

        .risk-label {
            flex-grow: 1;
            text-align: center;
            padding: 10px 5px;
            border: 2px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
        }

        .risk-label img {
            width: 30px;
            height: 30px;
            margin-bottom: 5px;
        }

        .risk-radio {
            display: none;
        }

        .risk-radio:checked + .risk-label {
            border-color: #007bff;
            background-color: #e6f0ff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
            color: #007bff;
        }
        
        /* Styles sp√©cifiques √† la l√©gende */
        .color-legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        .color-sample {
            width: 15px;
            height: 15px;
            border: 1px solid #555;
            margin-right: 8px;
            border-radius: 50%;
        }

        /* Styles du Tableau */
        #communeTableContainer table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
            font-size: 0.85em; 
            table-layout: auto; 
            color: black; 
        }
        #communeTableContainer th, #communeTableContainer td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
            word-wrap: break-word; 
        }
        #communeTableContainer th:last-child, #communeTableContainer td:last-child { 
            text-align: center;
        }
        #communeTableContainer th { 
            background-color: #e9ecef; 
            font-weight: 600; 
            line-height: 1.2; 
        }
        #communeTableContainer tbody tr:nth-child(odd) { background-color: #f8f9fa; }
        
        .leaflet-popup-content-wrapper { color: black; }


        .leaflet-control-home, .leaflet-control-share {
            background-color: white; width: 26px; height: 26px; line-height: 26px; text-align: center;
            cursor: pointer; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            margin-top: 2px; font-size: 14px; font-weight: bold;
        }
        .leaflet-control-home:hover, .leaflet-control-share:hover { background-color: #f4f4f4; }
        
        .leaflet-popup-content-wrapper { border-radius: 4px; }

        /* Styles pour le widget de coordonn√©es (Mouse Position) */
        #mouse-position-control {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 4px 8px;
            font-size: 12px;
            font-family: monospace;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            cursor: default;
        }
    </style>
</head>
<body>
    
    <div id="controls">
        <h2>S√©lection de Risque Technologique</h2>
        
        <div id="risk-selector-container">
            
            <input type="radio" id="risk-nuclear" name="risk-selector" class="risk-radio" value="nuclear" checked onchange="toggleRiskFromRadio(this.value)">
            <label for="risk-nuclear" class="risk-label">
                <img src="NUCLEAIRE.png" alt="Nucl√©aire">
                Nucl√©aire
            </label>
            
            <input type="radio" id="risk-industrial" name="risk-selector" class="risk-radio" value="industrial" onchange="toggleRiskFromRadio(this.value)">
            <label for="risk-industrial" class="risk-label">
                <img src="INDUS.png" alt="Industriel">
                Industriel
            </label>

            <input type="radio" id="risk-seveso" name="risk-selector" class="risk-radio" value="seveso" onchange="toggleRiskFromRadio(this.value)">
            <label for="risk-seveso" class="risk-label">
                <img src="SEVESO.png" alt="Seveso">
                Seveso
            </label>
        </div>
        
        <p>Risque Actif : <strong id="activeRiskName">Nucl√©aire</strong></p>

        <div id="legend-container">
            <h3>L√©gende Actuelle</h3>
            <div id="currentLegendContent"></div>
            </div>
        
        <div id="results-container">
            <div id="communeTableContainer">
            </div>
        </div>
        
    </div>

    <div id="map"></div>
    
    <script src="CENTROIDE.json"></script> 
    
    <script>
// ----------------------------------------------------------------------------------
// --- Configuration et Donn√©es ---
// ----------------------------------------------------------------------------------

let geojsonData = null; 

const FIELD_NOM_DEPARTEMENT = "nom"; 
const CHAMP_INSEE_DEPARTEMENT = "code_insee"; 
const FIELD_NUCLEAR = "Nucl√©aire";      
const FIELD_INDUSTRIAL = "Risque_ind";  
const FIELD_SEVESO_DEP = "Seveso 202";  

const DISPLAY_NAMES = {
    'nuclear': 'Nucl√©aire',
    'industrial': 'Industriel',
    'seveso': 'Seveso'
};

const MAX_RISK_NUCLEAR = 100; 
const MAX_RISK_INDUSTRIAL = 300; 
const MAX_RISK_SEVESO = 75; 

const MAX_CIRCLE_RADIUS = 40; 
const MIN_CIRCLE_RADIUS = 5; 

// Configuration : COULEUR UNIQUE PAR RISQUE
const THEME_COLORS = {
    'nuclear': '#E6C229', 
    'industrial': '#7E7973', 
    'seveso': '#6B8E23' 
};

const LAYERS_MAP = {
    'nuclear': { circles: null, name: 'nuclear', field: FIELD_NUCLEAR, maxCount: MAX_RISK_NUCLEAR, theme: THEME_COLORS.nuclear, displayName: DISPLAY_NAMES.nuclear },
    'industrial': { circles: null, name: 'industrial', field: FIELD_INDUSTRIAL, maxCount: MAX_RISK_INDUSTRIAL, theme: THEME_COLORS.industrial, displayName: DISPLAY_NAMES.industrial },
    'seveso': { circles: null, name: 'seveso', field: FIELD_SEVESO_DEP, maxCount: MAX_RISK_SEVESO, theme: THEME_COLORS.seveso, displayName: DISPLAY_NAMES.seveso }
};

const INITIAL_VIEW = [46.603354, 1.888334];
const INITIAL_ZOOM = 6; 

let currentActiveRiskType = 'nuclear'; 
var map; 

// ------------------------------------------------
// --- Fonctions de Style et de Couche GeoJSON ---
// ------------------------------------------------

function getCircleRadius(count, maxCount) {
    if (count === 0 || count === null) return 0;
    const ratio = Math.min(count / maxCount, 1);
    return MIN_CIRCLE_RADIUS + (MAX_CIRCLE_RADIUS - MIN_CIRCLE_RADIUS) * ratio;
}

function styleFeature(feature, riskData) {
    const riskField = riskData.field;
    const maxCount = riskData.maxCount;
    const color = riskData.theme; 

    const riskCount = feature.properties[riskField] || 0;
    const radius = getCircleRadius(riskCount, maxCount);

    if (radius === 0) {
        return { opacity: 0, fillOpacity: 0 };
    }
    
    return {
        radius: radius,
        fillColor: color, 
        color: '#555',                       
        weight: 1,
        opacity: 1,
        fillOpacity: 0.85
    };
}

function filterFeatures(feature, riskData) {
    const riskField = riskData.field;
    return (feature.properties[riskField] || 0) > 0;
}

function createDepartmentGeoJSONLayer(riskType) {
    const riskData = LAYERS_MAP[riskType];
    
    if (!geojsonData) {
        console.error("Les donn√©es GeoJSON n'ont pas √©t√© charg√©es.");
        return L.layerGroup(); 
    }

    const layer = L.geoJSON(geojsonData, {
        filter: function(feature) {
            return filterFeatures(feature, riskData);
        },
        pointToLayer: function (feature, latlng) {
            const style = styleFeature(feature, riskData);
            
            if (style.opacity === 0) return L.marker(latlng, { opacity: 0 }); 

            return L.circleMarker(latlng, style);
        },
        onEachFeature: function (feature, layer) {
             if (layer instanceof L.CircleMarker) {
                 const popupContent = createPopupContent(feature.properties, riskData);
                 layer.bindPopup(popupContent, {
                     closeButton: false,
                     offset: L.point(0, -5)
                 });
 
                 layer.on({
                     mouseover: onCircleMouseOver,
                     mouseout: onCircleMouseOut
                 });
             }
        }
    });
    
    return layer;
}

function onCircleMouseOver(e) {
    var layer = e.target;
    layer.setStyle({
        weight: 3, 
        fillOpacity: 1.0,
        color: 'black' 
    });
    layer.openPopup(e.latlng);
}

function onCircleMouseOut(e) {
    var layer = e.target;
    layer.setStyle({
        weight: 1, 
        fillOpacity: 0.85,
        color: '#555' 
    });
    layer.closePopup();
}

// --- Pop-ups, Tableau et Contr√¥les (Fonctions de donn√©es) ---

function createPopupContent(props, riskData) {
    const riskDisplayName = riskData.displayName;
    const fieldToUse = riskData.field; 
    const depName = props[FIELD_NOM_DEPARTEMENT];
    const depCode = props[CHAMP_INSEE_DEPARTEMENT];
    const riskCount = props[fieldToUse] || 0; 
    
    return `<strong>D√©partement : ${depName} (${depCode})</strong><br>
            Communes soumises √† un risque ${riskDisplayName} : 
            <strong>${riskCount}</strong>`;
}

function updateDepartmentTable(riskType) {
    const riskData = LAYERS_MAP[riskType];
    const activeRiskField = riskData.field;
    const activeRiskDisplayName = riskData.displayName;
    
    const container = document.getElementById('communeTableContainer');
    
    if (!geojsonData || geojsonData.features.length === 0) {
        container.innerHTML = `<p>Donn√©es indisponibles.</p>`;
        return;
    }

    const concernedFeatures = geojsonData.features
        .filter(f => (f.properties[activeRiskField] || 0) > 0)
        .sort((a, b) => (b.properties[activeRiskField] || 0) - (a.properties[activeRiskField] || 0));

    if (concernedFeatures.length === 0) {
        container.innerHTML = `<p>Aucun d√©partement n'est r√©pertori√© avec un risque ${activeRiskDisplayName}.</p>`;
        return;
    }
    
    let tableHTML = `<h4>D√©partements concern√©s (${concernedFeatures.length}) :</h4><table><thead><tr>`;
    tableHTML += `<th>D√©partement</th><th>Nb Communes Soumises</th>`; 
    tableHTML += '</tr></thead><tbody>';

    concernedFeatures.forEach(function (feature) {
        const props = feature.properties;
        const riskValue = props[activeRiskField] || 0;
        
        tableHTML += '<tr>';
        tableHTML += `<td>${props[FIELD_NOM_DEPARTEMENT]} (${props[CHAMP_INSEE_DEPARTEMENT]})</td>`;
        tableHTML += `<td style="text-align: center; font-weight: bold;">${riskValue}</td>`;
        tableHTML += '</tr>';
    });

    tableHTML += '</tbody></table>';
    container.innerHTML = tableHTML;
}

// FONCTION DE L√âGENDE MISE √Ä JOUR (SIMPLE TAILLE - Texte court)
function renderSimpleSizeLegend(riskType) {
    const riskData = LAYERS_MAP[riskType];
    
    const maxCount = riskData.maxCount;
    const maxRadius = MAX_CIRCLE_RADIUS;
    const minRadius = MIN_CIRCLE_RADIUS;
    const middleCount = Math.round(maxCount / 2);
    const middleRadius = getCircleRadius(middleCount, maxCount);
    const color = riskData.theme; 

    let content = `<h4>Quantit√© de Risque ${riskData.displayName}</h4>`;
    
    content += `<p>La taille du cercle est un indicateur visuel proportionnel repr√©sentant le Nombre de Communes soumises au risque par d√©partement.</p>`;

    content += `<div style="padding-top: 10px;">`;
    content += `<p style="font-weight: bold; margin-bottom: 5px; border-bottom: 1px dashed #ccc;">√âchelle des Tailles (Nombre de Communes):</p>`;

    const sizeExamples = [
        { count: maxCount + '+', radius: maxRadius },
        { count: middleCount, radius: middleRadius },
        { count: 1, radius: minRadius }
    ];

    sizeExamples.forEach(ex => {
        const svgSize = maxRadius * 2;
        
        content += `
            <div style="display: flex; align-items: center; margin-bottom: 15px; height: ${svgSize}px;">
                <svg width="${svgSize + 10}" height="${svgSize}" style="margin-right: 10px; flex-shrink: 0;">
                    <circle cx="${maxRadius}" cy="${maxRadius}" r="${ex.radius}" 
                            fill="${color}" fill-opacity="0.85" stroke="#555" stroke-width="1" />
                </svg>
                <span style="font-weight: bold;">${ex.count}</span>
            </div>
        `;
    });
    
    content += `</div>`; 
    
    // Ligne pour l'absence de risque
    content += `
        <div style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px;">
            <p style="font-weight: bold; margin-bottom: 5px;">Absence / Donn√©e Non Pertinente :</p>
            <div class="color-legend-item">
                <span class="color-sample" style="background-color: #ccc; border-color: #ccc;"></span>
                <span style="color: black;">Aucune commune soumise (Ou donn√©e nulle)</span>
            </div>
        </div>
    `;
    
    document.getElementById('currentLegendContent').innerHTML = content;
}


function toggleRisk(newRiskType) {
    
    const oldRiskType = currentActiveRiskType;
    currentActiveRiskType = newRiskType;
    
    const oldLayers = LAYERS_MAP[oldRiskType];
    if (oldLayers.circles && map.hasLayer(oldLayers.circles)) {
        map.removeLayer(oldLayers.circles);
    }
    
    const newLayers = LAYERS_MAP[newRiskType];
    if (newLayers.circles) {
        newLayers.circles.addTo(map); 
        
        renderSimpleSizeLegend(newRiskType); 
        updateDepartmentTable(newRiskType); 
    }
}

function toggleRiskFromRadio(riskType) {
    const riskName = LAYERS_MAP[riskType].displayName;
    document.getElementById('activeRiskName').textContent = riskName;
    
    toggleRisk(riskType);
}

function resetMapView() { 
    const activeRiskType = currentActiveRiskType;
    
    map.flyTo(INITIAL_VIEW, INITIAL_ZOOM);
    
    renderSimpleSizeLegend(activeRiskType); 
    updateDepartmentTable(activeRiskType); 
}

// ------------------------------------------------
// --- INITIALISATION ---
// ------------------------------------------------

// D√©finition d'un contr√¥le de coordonn√©es simple (Mouse Position)
var MousePositionControl = L.Control.extend({
    options: {
        position: 'bottomleft',
        separator: ' | ',
        emptyString: 'Survolez la carte',
        numDigits: 4,
        prefix: "Coordonn√©es: "
    },

    onAdd: function (map) {
        this._container = L.DomUtil.create('div', 'leaflet-control-mouseposition');
        this._container.id = 'mouse-position-control';
        L.DomEvent.disableClickPropagation(this._container);
        map.on('mousemove', this._onMouseMove, this);
        this._container.innerHTML = this.options.emptyString;
        return this._container;
    },

    onRemove: function (map) {
        map.off('mousemove', this._onMouseMove)
    },

    _onMouseMove: function (e) {
        var lng = L.Util.formatNum(e.latlng.lng, this.options.numDigits);
        var lat = L.Util.formatNum(e.latlng.lat, this.options.numDigits);
        var value = this.options.prefix + lng + this.options.separator + lat;
        this._container.innerHTML = value;
    }
});

// Contr√¥le de Partage/Lien
var ShareControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function(map) {
        var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-share');
        container.innerHTML = 'üîó'; // Ic√¥ne de Lien/Cha√Æne
        container.title = 'Copier l\'URL de la carte interactive pour le partage';
        
        L.DomEvent.on(container, 'click', function() {
            try {
                const shareUrl = window.location.href;
                navigator.clipboard.writeText(shareUrl);
                alert("Lien de la carte copi√© dans le presse-papiers :\n" + shareUrl);
            } catch (err) {
                console.error("√âchec de la copie automatique du lien.", err);
                alert("Impossible de copier le lien automatiquement. L'URL est : \n" + window.location.href);
            }
        });
        return container;
    }
});


function loadAndInitialize() {
    if (typeof centroide === 'undefined') {
        console.error("ERREUR CRITIQUE: La variable 'centroide' n'est pas d√©finie. V√©rifiez le chemin et le contenu du fichier CENTROIDE.json.");
        document.getElementById('communeTableContainer').innerHTML = `<p style="color:red;">ERREUR: CENTROIDE.json non charg√© ou variable non trouv√©e.</p>`;
        return;
    }
    
    geojsonData = centroide;
    
    map = L.map('map').setView(INITIAL_VIEW, INITIAL_ZOOM); 
    
    // ATTRIBUTION MODIFI√âE : Ajout de la source de donn√©es Observatoire des Territoires
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', { 
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a> | Source: <a href="https://www.observatoire-des-territoires.gouv.fr/">Observatoire des Territoires</a>',
        maxZoom: 19
    }).addTo(map);

    for (const key in LAYERS_MAP) {
        LAYERS_MAP[key].circles = createDepartmentGeoJSONLayer(key);
    }

    // --- Ajout des Widgets Cartographiques ---
    
    // 1. Contr√¥le Accueil (Home Control)
    var HomeControl = L.Control.extend({
        options: { position: 'topleft' },
        onAdd: function(map) {
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-home');
            container.innerHTML = 'üè†';
            container.title = 'Retour √† la vue initiale (Accueil)';
            L.DomEvent.on(container, 'click', function() { resetMapView(); });
            return container;
        }
    });
    map.addControl(new HomeControl());
    
    // 4. Contr√¥le de Partage
    map.addControl(new ShareControl());

    // 2. Contr√¥le d'√âchelle (Scale Control)
    L.control.scale({ imperial: false, position: 'bottomright' }).addTo(map);

    // 3. Contr√¥le de Coordonn√©es (Mouse Position)
    map.addControl(new MousePositionControl());
    
    const defaultRisk = document.querySelector('input[name="risk-selector"]:checked').value;
    toggleRiskFromRadio(defaultRisk); 
}

window.onload = loadAndInitialize;
    </script>
    
</body>
</html>
